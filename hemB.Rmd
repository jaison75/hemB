---
title: "PicnicHealth Hemophilia B subset Analysis"
author: "Jaison Jacob"
date: "2022-10-23"
output: html_document
---

```{r setup, include=TRUE, message = FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
library(ggplot2)
library(PicnicHealth)
library(PicnicBlanket)
library(magrittr)
library(DT)
library(ggpmisc)
library(kableExtra)

filename <- "/Users/poops/Projects/hemB/sample_dataset/data"
hemB <- load_data_set(filename)
```
```{r other_settings, echo = FALSE}
blanks <- rep(c(' ', '\n'),5) # This will print five blank lines between plots. 

AddBreak <- function() {
for (i in blanks)
  cat(i)
}
```


## Hemophilia B test dataset exploration

The goal of this analysis is to assess the hypothesis that compared to mild or moderate hemophilia B patients, patients with severe hemophilia B have:

1. higher healthcare utilization 
2. more bleeds.

Our definition of the phenotypic severity will be as follows:

* Patients with a baseline factor IX level of <1% have severe hemophilia
* Patients with a baseline factor IX level of 1-5% have moderate hemophilia
* Patients with a baseline factor IX level of 5-50% have mild hemophilia 


Table 1. Patient characteristics for this exploratory cohort is shown above.
```{r table_1, include = TRUE}
table_one( hemB)

```


Table 1. shows that the paients are all Males, consistent with the fact that this is an X-linked genetic disease. Now let us start diving into the ***<span style="color:red">baseline</span>*** data and create data subsets for easy exploration and analysis.  The code below parses the baseline dataset and creates a severity index using our definitions above based on the Coagulation factor IX activity actual/normal in Platelet poor plasma by Coagulation assay.

```{r clean_baseline_data, include = TRUE}
severity_data <- hemB$baseline %>% 
  dplyr::filter(measurement_concept_id == "8b961efa-cc89-55c3-bcd8-e83c74cb4612") %>% 
  dplyr::mutate(value_as_range = tidyr::replace_na(value_as_range,"{}")) %>% 
  dplyr::mutate(tidyjson::spread_all(value_as_range)) %>% 
  dplyr::mutate(baseline_value = dplyr::case_when(
    recorded_value_type == "number" ~ value_as_number, 
    type %in% c("lessThan", "lessThanOrEqualTo") ~ borderValue - 0.1, 
    type %in% c("greaterThanOrEqualTo", "greaterThan") ~ borderValue + 0.1, 
    type == "between" ~ (lowValue + highValue)/2)) %>% 
  dplyr::mutate(b_severity = dplyr::case_when(
    baseline_value <  1 ~ "Severe", 
    baseline_value >= 1 & baseline_value <= 5 ~ "Moderate", 
    baseline_value > 5 & baseline_value <=  50 ~ "Mild", 
    baseline_value > 50 ~ "Normal")) %>% 
  dplyr::group_by(person_id) %>% 
  dplyr::filter(baseline_value == min(baseline_value)) %>%
  dplyr::distinct( person_id, baseline_value, b_severity ) %>%
  dplyr::arrange( baseline_value )

severity_data$person_id = factor(severity_data$person_id, 
                                 levels = severity_data$person_id)
```

```{r show_severity, echo = FALSE}
severity_data %>%
  kbl(caption = "Table 2. Severity Data") %>%
    kable_styling(bootstrap_options = "striped", full_width = F, position = "center", 
                  html_font = "Cambria")
```



Now we will explore the ***<span style="color:red">visit</span>*** data to obtain healthcare utilization information from *Inpatient Visits* and *Outpatient Visits* columns.

```{r hosp_data, include = TRUE, echo = TRUE}
hospitalization_data <- hemB$visit %>%
  dplyr::mutate(hosp_days = difftime(hemB$visit$visit_end_date,
                                     hemB$visit$visit_start_date, units = "days") %>%
                  as.integer) %>% 
  dplyr::group_by( person_id, visit_concept_name) %>%
  dplyr::mutate( visit_type_count = dplyr::n(),
                 total_hosp_days = sum(hosp_days)) %>%
  dplyr::ungroup() %>%
  dplyr::distinct( person_id, visit_concept_name, visit_type_count, total_hosp_days) %>%
  tidyr::pivot_wider( names_from = visit_concept_name,
                      values_from = c(visit_type_count, total_hosp_days)) %>%
  dplyr::select( person_id,
                 in_visits  = `visit_type_count_Inpatient Visit`,
                 out_visits = `visit_type_count_Outpatient Visit`,
                 overnight_hosp = `total_hosp_days_Inpatient Visit`) %>%
  dplyr::left_join( severity_data, by = "person_id") %>%
  dplyr::arrange( baseline_value ) %>%
  dplyr::mutate( total_visits = tidyr::replace_na(in_visits,0) + 
                   tidyr::replace_na(out_visits, 0))

hospitalization_data$person_id = factor(hospitalization_data$person_id, 
                                 levels = hospitalization_data$person_id)

age_data <- hemB$person %>%
  dplyr::mutate(age_at_enroll = difftime(enrollment_date, 
                                         date_of_birth,
                                         units = "days")/365 %>%
  as.numeric()) %>%
  dplyr::select(person_id,age_at_enroll, 
                sex = sex_concept_name, 
                race  = race_concept_name) %>%
  dplyr::left_join( severity_data, by = "person_id") %>%
  dplyr::arrange( baseline_value ) %>%
  dplyr::mutate(age_at_enroll = sprintf("%0.1f", age_at_enroll))

age_data$person_id = factor(age_data$person_id, 
                                 levels = age_data$person_id)

age_data <- dplyr::left_join( age_data, severity_data)

hospitalization_data <- dplyr::left_join( age_data, hospitalization_data) %>%
  dplyr::mutate( label1 = sprintf("Age = %s; Overnights = %s", 
                                 age_at_enroll,in_visits),
                 label2 = sprintf("Age = %s; Overnights = %s", 
                                 age_at_enroll,out_visits),
                 label3 = sprintf("Age = %s; Overnights = %s", 
                                 age_at_enroll,overnight_hosp),
                 )

```


```{r show_hosp, echo = FALSE}
hospitalization_data %>%
  dplyr::select(-c(label1, label2, label3)) %>%
  kbl(caption = "Table 2. Hospitalization Data") %>%
    kable_styling(bootstrap_options = "striped", full_width = F, position = "center", 
                  html_font = "Cambria")
```

```{r plot_hosp, echo = FALSE, warning=FALSE}

ggplot( hospitalization_data,
        aes( x= in_visits, 
             y=person_id, 
             label = label1,
             fill = b_severity)) +
    geom_bar(  stat = "identity") +
    geom_text( aes(x=10), size = 2, hjust = 0) +
    ggtitle("Figure 1. In-Patient Visits vs Patient ID") +
  ylab( "Patient ID") +
  xlab("In-patient Visits")+
  labs( fill = "Severity")

cat("\n\n")
cat("\n\n")

ggplot( hospitalization_data,
        aes( x= out_visits, 
             y=person_id, 
             label = label2,
             fill = b_severity)) +
    geom_bar(  stat = "identity") +
    geom_text( aes(x=10), size = 2, hjust = 0) +
  ggtitle("Figure 2. Out-Patient Visits vs Patient ID") +
  ylab( "Patient ID") +
  xlab("Out-patient Visits") +
  labs( fill = "Severity")

cat("\n\n")
cat("\n\n")

ggplot( hospitalization_data,
        aes( x= overnight_hosp, 
             y=person_id, 
             label = label3,
             fill = b_severity)) +
    geom_bar(  stat = "identity") +
    geom_text( aes(x=10), size = 2, hjust = 0) +
  ggtitle("Figure 3. Overnight Hospitalization vs Patient ID") +
  ylab( "Patient ID") +
  xlab("Overnight Hospitalization")+
  labs( fill = "Severity")

```

No strong correlations seen between severeity as defined and either In-patient or Out-patient vist counts.  However, there seems to be a weak correlation between overnight hospitalizations.  There seems to be one patient classified as moderate that seems to be breaking the trend.  

Next, let us look at the ***<span style="color:red">bleed_rate</span>*** to see if there are any straightforward correlations between severity as we have defined vs number of bleeds. 



```{r bleed_rate, include = TRUE}
bleed_data <- hemB$bleed_rate %>%
  dplyr::mutate( bleed_days = 
                   dplyr::case_when(
                     bleed_window_type == "Bleeds between two dates" ~
                       (bleed_window_end_date -
                          bleed_window_start_date) %>% as.numeric,
                     bleed_window_type == "Bleeds per unit time" ~
                       dplyr::case_when( bleed_window_unit_time == "Per 6 Months" ~ 6*30.5 ,
                                         bleed_window_unit_time == "Per Month" ~ 30.5,
                                         bleed_window_unit_time == "Per Year" ~ 365,
                                         bleed_window_unit_time == "Per 6 Weeks" ~ 6*7,
                                         bleed_window_unit_time == "Per 2 Weeks" ~ 2*7,
                                         bleed_window_unit_time == "Per Week" ~ 7,
                                         bleed_window_unit_time == "Per 2 Months" ~ 2*30.5,
                                         bleed_window_unit_time == "Per 3 Months" ~ 3*30.5
                       )  
                   )
  ) %>%
  dplyr::mutate(bleed_count_as_range = tidyr::replace_na(bleed_count_as_range,"{}")) %>% 
  dplyr::mutate(tidyjson::spread_all(bleed_count_as_range)) %>% 
  dplyr::mutate(bleed_count_in_period = dplyr::case_when(
    recorded_bleed_count_type == "number" ~ bleed_count_as_number, 
    type %in% c("lessThan") ~ borderValue - 1, 
    type == "between" ~ (lowValue + highValue)/2)) %>%
  dplyr::left_join(age_data)
  
bleed_data$person_id = factor( bleed_data$person_id,
                               levels = levels(age_data$person_id))

bleed_data <- bleed_data %>% droplevels %>%
  dplyr::group_by( person_id) %>%
  dplyr::mutate( total_bleeds = sum(bleed_count_in_period),
                 total_bleed_days = sum(bleed_days),
                 std_bleed_count = total_bleeds/total_bleed_days*365)

```

Since the number of bleeds will depend on the number of days where this information is recorded, we should ideally be looking at some standardized varibale.  We define a new variable ___standardized bleed count = 365 * (total number of bleeds per patient)/(total number of bleed days)___.


```{r plot_bleed_rate, echo = FALSE, warning=FALSE}

ggplot( bleed_data, aes(x=bleed_window_collection_date, 
                        y= reorder(person_id,std_bleed_count) ,
                        size=std_bleed_count, 
                        color = b_severity)) + 
  geom_point() +
  ggtitle("Figure 4. Standardized bleed count plot") +
  ylab( "Patient ordered by standardized bleed count") +
  xlab("Bleed window collection date")+
  labs( color = "Severity", size = "Std. bleed count")
  

cat("\n\n\n\n")

ggplot( bleed_data, aes(x=bleed_window_collection_date, 
                        y= person_id , 
                        size=bleed_count_in_period,
                        color = b_severity)) +
  geom_point() +
  ggtitle("Figure 5. Bleed count at every bleed period") +
  ylab( "Patient ID") +
  xlab("Bleed window collection date")+
  labs( color = "Severity", size = "Bleed counts per period")

cat("\n\n\n\n")

```

```{r bleed_data_2, include = TRUE}

bleed_data2 <- bleed_data %>%
  dplyr::group_by( person_id) %>%
  dplyr::mutate( total_bleed_days = sum(bleed_days),
                 total_bleeds = sum(bleed_count_in_period),
                 overall_bleed_rate = total_bleeds/total_bleed_days*365 ) %>%
  dplyr::ungroup() %>%
  dplyr::distinct( person_id, age_at_enroll, sex, race,total_bleed_days,total_bleeds, overall_bleed_rate ) %>%
  dplyr::left_join(age_data)
  
bleed_data2$person_id = factor( bleed_data2$person_id,
                               levels = levels(age_data$person_id))

bleed_data2 <- bleed_data2 %>% droplevels

```


```{r show_bleed_rate, echo = FALSE}
bleed_data2 %>%
  kbl(caption = "Table 3. Bleed rate Data") %>%
    kable_styling(bootstrap_options = "striped", full_width = F, position = "center", 
                  html_font = "Cambria")
```

```{r bleeds, warning=FALSE}
bleeds <- hemB$bleed %>%
  dplyr::group_by( person_id, bleed_type_concept_name ) %>%
  dplyr::summarise(count = dplyr::n()) %>% 
  dplyr::left_join( age_data) %>%
  dplyr::ungroup() %>%
  dplyr::group_by( person_id) %>%
  dplyr::mutate( total_episodes = sum(count)) %>%
  dplyr::ungroup() %>%
  dplyr::arrange( baseline_value, total_episodes, count) %>%
  dplyr::left_join(age_data)

bleeds$person_id = factor( bleeds$person_id,
                               levels = levels(age_data$person_id))

bleeds <- bleeds %>% droplevels

ggplot(bleeds, aes(y=total_episodes, 
              x= reorder(person_id, total_episodes), 
              fill = b_severity
              )) +
  geom_bar(stat = "identity") +
  coord_flip() +
  ggtitle("Figure 6. Total Bleeds from bleeds table") +
  xlab( "Patient ID ordered by total bleeds") +
  ylab("Total bleeding episodes")+
  labs( fill = "Severity") 
cat("\n\n\n\n")


```


Based on Figure 6, one could potentially make an argument that perhaps there is some evidence that severity as we have defined is associated with total number of bleeding episodes.  One can even be tempted to fit a regression line like shown in Figure 7.

```{r fit, echo = FALSE}
bleeds_distinct <- bleeds %>% 
  dplyr::distinct( person_id, b_severity, baseline_value, total_episodes ) %>%
  dplyr::mutate( b_severity = factor(b_severity))

ggplot(bleeds_distinct, 
       aes(x = as.numeric(b_severity), 
           y = total_episodes)) +
  geom_point() +
  geom_smooth(method = 'glm') +
    scale_x_continuous(name = "Severity",
                       breaks=c(1,2,3),
                       labels = c("Mild", "Moderate", "Severe"),
                       minor_breaks = NULL) +
  ggtitle("Figure 7. Total Bleeds vs Severity") +
  ylab( "Total bleeding episodes") +
  xlab("Severity")

```
## Conclusion

It does not appear that the hypothesis that the severity as we define is associated with healthcare utilization or more bleeds.  It is unclear if  the ***<span style="color:red">bleed</span>*** was recorded systematically during a set period and if the bleed data were recorded in light of any prophylactic Factor IX usage.  For example , there is one patient, 86337351-2c6f-4b5d-8b43-378fa6006b9, with a *Moderate* classification, who is a 20 year old patient.  This patient has higher hospitalizations and more bleed episodes that are similar to those in the severe category.  Several variables can potentially affect these. It might be worth asking if this patient for example, has better access to health care or someone invloved in activities (like contact sports) that could increase the chances of bleeding episodes.  If patients are on phrophylaxis, it will be good to understand the dose, time from last admininstration of the therapy before recording the coagulation asaay, halflife of the specific drug used etc.  A larger dataset could ptentially be helpful
